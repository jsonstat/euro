var datasetsElement=document.querySelector("#datasets"),dimElement=document.querySelector("#dimensions"),dataElement=document.querySelector("#data");function datasets(e){var t=[];return t.push('<select name="ds"><option value="">Choose a dataset</option>'),e.forEach(function(e,a){var n=e.dataset,o=e.label.dataset;t.push('<option value="'+a+'">'+o+" ("+n+")</option>")}),t.push("</select>"),t.join("")}function getMeta(e){if(dataElement.innerText="",null===e)return warn("META","RESET");e.lang=document.querySelector("#languages input[type=radio]:checked").value,warn("META","FETCH"),EuroJSONstat.fetchFullQuery(e).then(function(t){if("error"===t.class)return warn("META","ERROR",t.status,t.label);dimensions(EuroJSONstat.getEmptyDataset(t),e)})}function dimensions(e,t){var a=[];sortByRole(e.role).forEach(function(t){var n=e.Dimension(t),o=n.length,r=1===o,l=n.role;a.push('<details class="'+l+'">'),a.push("<summary>"+ico(l)+n.label+'</summary><div class="cont"><div id="items">'),r||a.push('<label><input onclick="chkall(&apos;'+t+'&apos;,this)" type="checkbox" />All</label>'),n.id.forEach(function(e,c,i){var s="";if("time"!==l)r||(s='<input class="filter" type="checkbox" name="'+t+'" value="'+e+'"/>'),a.push("<label>"+s+n.Category(e).label+"</label>");else{var u=o-c-1;r||(s='<input onclick="timechk(&apos;item&apos;)" class="filter" type="checkbox" name="'+t+'" value="'+i[u]+'"/>'),a[a.length+u]="<label>"+s+n.Category(u).label+"</label>"}}),"time"===l&&a.push(period(o)),a.push("</div></div></details>")});var n=t.filter?"Selection required":"";a.push('<div id="button"><button class="btn btn-default" id="get">Load Data</button><span id="down"><a id="csv"></a></span><span id="msg">'+n+"</span></div>"),dimElement.innerHTML=a.join(""),document.querySelector("button").addEventListener("click",function(){document.querySelector("#data").innerHTML="",document.querySelector("#down").innerHTML='<a id="csv"></a>',getData(removeFilter(t),e.id)})}function period(e){for(var t=[],a=0;a<e;a++)t.push('<option value="'+(a+1)+'">'+(a+1)+"</option>");return'</div><div id="number"><label><input class="filter" onclick="timechk(&apos;number&apos;)" type="checkbox" name="lasttime">Number of last periods<select onchange="timechk(&apos;select&apos;)" name="lastTimePeriod">'+t.join("")+"</select></label>"}function timechk(e){var t=document.querySelector(".time #number input");"select"===e&&(t.checked=!0,e="number"),"number"===e?Array.prototype.forEach.call(document.querySelectorAll(".time #items input"),function(e){e.checked=!1}):document.querySelector(".time #number input").checked=!1}function sortByRole(e){return e.geo.concat(e.time,e.metric,e.classification)}function removeFilter(e){return delete e.filter,e}function getData(e,t){warn("DATA","FETCH");var a={};t.forEach(function(e){a[e]=[],Array.prototype.forEach.call(document.querySelectorAll("input.filter[name="+e+"]"),function(t){t.checked&&a[e].push(t.value)}),document.querySelector("input[name=lasttime]").checked&&(delete a.time,a.lastTimePeriod=[document.querySelector("select[name=lastTimePeriod] option:checked").value])});var n=EuroJSONstat.addParamQuery(e,a);EuroJSONstat.fetchDataset(n).then(function(e){if("error"!==e.class){warn("DATA","RESET");var t=e.extension.status?statusInfo(e.extension.status.label):"";dataElement.innerHTML=JSONstatUtils.datalist(e,{counter:!0,tblclass:"datalist",numclass:"number",valclass:"value",vlabel:"VALUE",status:!0,slabel:"STATUS",na:" ",locale:n.lang})+t;var a=document.querySelector("#csv");if(void 0!==a.download){var o=JSONstatUtils.toCSV(e,{status:!0,slabel:"status",vlabel:"value",na:" "});a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(o),a.download=e.extension.datasetId+".csv",a.className="btn btn-default",a.innerHTML="Download CSV"}addTopAndCaption(EuroJSONstat.getURL(n))}else"416"===e.status?warn("DATA","416"):warn("DATA","ERROR",e.status,e.label)})}function chkall(e,t){Array.prototype.forEach.call(document.querySelectorAll("input[name="+e+"]"),function(e){e.checked=t.checked}),"time"===e&&(document.querySelector("#number input").checked=!1)}function ico(e){var t="glyphicon-signal";switch(e){case"geo":t="glyphicon-map-marker";break;case"time":t="glyphicon-time";break;case"metric":t="glyphicon-dashboard"}return'<span title="'+e+'" class="glyphicon '+t+'"></span> '}function addTopAndCaption(e){var t=document.querySelector(".datalist tr > th"),a=document.querySelector(".datalist tfoot td"),n=a.innerText;t.innerHTML='<a title="Up" href="#top">#</a>',t.id="top",a.innerHTML=n+'<a title="Top of the table" href="#top">&uarr;</a>',document.querySelector("caption").innerHTML=e.replace(/&/g,"&<wbr>")}function warn(e,t,a,n){var o,r="META"===e?dimElement:document.querySelector("#msg");switch(t){case"FETCH":o="META"===e?"Retrieving metadata...":"Retrieving data...";break;case"416":o="Too many cells requested. Please, select fewer categories.";break;case"ERROR":o="Sorry, an error ocurred: "+a+" ("+n+")";break;case"RESET":o=""}r.innerText=o}function statusInfo(e){var t=[];return t.push('<div id="status">'),Object.keys(e).forEach(function(a){t.push("<p><tt>"+a+"</tt> = "+e[a]+"</p>")}),t.push("</div>"),t.join("")}fetch("https://jsonstat.github.io/euro/queries.json").then(function(e){e.json().then(function(e){datasetsElement.innerHTML=datasets(e),document.querySelector("select").addEventListener("change",function(t){getMeta(""===t.target.value?null:e[t.target.value])})})});
